<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON Cloud Miner Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: #050a18;
            color: white;
            user-select: none;
            overflow-x: hidden;
        }

        .glass {
            background: rgba(255, 255, 255, 0.07);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px;
        }

        #page-mining { background: radial-gradient(circle at top, #0088cc22, transparent); }
        #page-tasks { background: radial-gradient(circle at top, #8b5cf622, transparent); }
        #page-referral { background: radial-gradient(circle at top, #f59e0b22, transparent); }
        #page-withdraw { background: radial-gradient(circle at top, #10b98122, transparent); }

        .mining-circle {
            width: 220px; height: 220px;
            border-radius: 50%;
            background: linear-gradient(145deg, #0088cc, #004466);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 40px rgba(0, 136, 204, 0.4);
            transition: 0.3s;
        }

        .active-mining .mining-circle {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 20px #0088cc; }
            50% { transform: scale(1.08); box-shadow: 0 0 60px #0088cc; }
            100% { transform: scale(1); box-shadow: 0 0 20px #0088cc; }
        }

        .btn-grad {
            background: linear-gradient(90deg, #0088cc, #00c6ff);
            transition: 0.3s;
        }

        .tab-active { color: #0088cc; position: relative; }
        .tab-active::after {
            content: ''; position: absolute; bottom: -5px; left: 25%; width: 50%; height: 3px; background: #0088cc; border-radius: 10px;
        }
    </style>
</head>
<body>

    <div class="p-6 flex justify-between items-center">
        <div onclick="checkAdminTrigger()" id="botLogo" class="w-12 h-12 glass flex items-center justify-center cursor-pointer active:scale-90 transition">
            <img src="https://ton.org/download/ton_symbol.svg" class="w-8" alt="TON">
        </div>
        <div class="glass px-5 py-2">
            <span class="text-[10px] block opacity-60 uppercase tracking-widest">Balance</span>
            <span id="balance" class="text-xl font-black text-blue-400">0.0000</span> <span class="text-xs">TON</span>
        </div>
    </div>

    <div id="page-mining" class="page active p-6 text-center">
        <h1 class="text-2xl font-black mb-2">Cloud Mining</h1>
        <p class="text-xs opacity-60 mb-8">Session duration: <span id="sessionTimeText">60</span> minutes</p>
        <div class="flex justify-center mb-10" id="miningBox">
            <div class="mining-circle">
                <div class="text-center">
                    <span id="liveCounter" class="text-3xl font-mono block">0.000000</span>
                    <span class="text-[10px] uppercase tracking-widest opacity-80">Mining...</span>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-8 text-left">
            <div class="glass p-4">
                <span class="text-[10px] block opacity-50 uppercase">Session Profit</span>
                <span id="hourlyProfitText" class="font-bold text-blue-300">0.0001</span>
            </div>
            <div class="glass p-4">
                <span class="text-[10px] block opacity-50 uppercase">Time Left</span>
                <span id="timerText" class="font-bold text-yellow-400">00:00</span>
            </div>
        </div>
        <button onclick="startMiningProcess()" id="startBtn" class="w-full py-5 rounded-3xl btn-grad font-black text-lg shadow-lg uppercase tracking-tighter">Start Mining Session</button>
    </div>

    <div id="page-tasks" class="page hidden p-6">
        <h1 class="text-2xl font-black mb-6 text-purple-400">Daily Quests</h1>
        <div class="space-y-4" id="tasksContainer"></div>
    </div>

    <div id="page-referral" class="page hidden p-6">
        <h2 class="text-2xl font-black mb-4 text-orange-400">Invite Friends</h2>
        <div class="glass p-6 mb-6 overflow-hidden relative">
            <div class="relative z-10 text-center">
                <img src="https://cdn-icons-png.flaticon.com/512/8135/8135968.png" class="w-24 mx-auto mb-4 drop-shadow-2xl">
                <p class="text-sm mb-4">Earn <span class="text-orange-400 font-bold" id="refBonusText">0.0001</span> TON for every friend!</p>
                <div class="flex gap-2">
                    <input id="refLink" type="text" readonly value="Loading..." class="flex-1 bg-black/40 p-3 rounded-xl text-[10px] border border-white/10 outline-none">
                    <button onclick="copyRef()" class="bg-orange-500 px-4 rounded-xl font-bold text-xs">COPY</button>
                </div>
            </div>
        </div>
        <div class="glass p-4">
            <h3 class="font-bold mb-4 flex justify-between items-center">
                <span class="text-sm">Friends List</span>
                <span id="refCount" class="text-orange-400 bg-orange-400/10 px-2 py-1 rounded-lg">0</span>
            </h3>
            <div id="refList" class="space-y-3 max-h-40 overflow-y-auto"></div>
        </div>
    </div>

    <div id="page-withdraw" class="page hidden p-6">
        <h2 class="text-2xl font-black mb-6 text-emerald-400">Withdrawal</h2>
        <div class="glass p-6 mb-6">
            <div class="mb-4">
                <label class="text-[10px] opacity-50 block mb-1 uppercase tracking-widest">TON Wallet Address</label>
                <input id="walletAddr" type="text" placeholder="UQ..." class="w-full bg-black/40 p-4 rounded-2xl outline-none border border-white/5 focus:border-emerald-500 transition">
            </div>
            <div class="mb-6">
                <label class="text-[10px] opacity-50 block mb-1 uppercase tracking-widest">Amount (Min: <span id="minWithdrawText">0.1</span>)</label>
                <input id="withdrawAmount" type="number" placeholder="0.0" class="w-full bg-black/40 p-4 rounded-2xl outline-none border border-white/5 focus:border-emerald-500 transition">
            </div>
            <button onclick="requestWithdraw()" class="w-full bg-emerald-600 py-4 rounded-2xl font-black shadow-xl uppercase">Confirm Request</button>
        </div>
        <h3 class="font-bold mb-3 text-sm opacity-70">Withdrawal History</h3>
        <div id="withdrawHistory" class="space-y-2"></div>
    </div>

    <div id="adminPanel" class="fixed inset-0 bg-[#050a18] z-[100] p-6 overflow-y-auto hidden">
        <div class="flex justify-between items-center mb-8 border-b border-white/10 pb-4">
            <h2 class="text-xl font-black text-red-500 uppercase tracking-tighter">Admin Panel</h2>
            <button onclick="closeAdmin()" class="bg-white/10 w-10 h-10 rounded-full text-2xl">&times;</button>
        </div>
        <div class="space-y-6">
            <div class="glass p-4 space-y-4">
                <h3 class="text-sm font-bold text-blue-400">Sync Settings</h3>
                <div>
                    <label class="text-xs">Mining Time (Mins):</label>
                    <input id="adm_miningTime" type="number" class="w-full bg-white/5 p-2 rounded-lg border border-white/10">
                </div>
                <div>
                    <label class="text-xs">Mining Profit:</label>
                    <input id="adm_miningProfit" type="number" step="0.0001" class="w-full bg-white/5 p-2 rounded-lg border border-white/10">
                </div>
                <button onclick="saveAdminChanges()" class="w-full bg-blue-600 py-3 rounded-xl font-bold uppercase">Save To Cloud</button>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 glass m-4 py-3 flex justify-around items-center border-t-0 shadow-2xl">
        <button onclick="switchTab('mining', this)" class="flex flex-col items-center gap-1 tab-active">
            <span class="text-xl">‚õèÔ∏è</span><span class="text-[10px]">Mining</span>
        </button>
        <button onclick="switchTab('tasks', this)" class="flex flex-col items-center gap-1 opacity-50">
            <span class="text-xl">üéØ</span><span class="text-[10px]">Tasks</span>
        </button>
        <button onclick="switchTab('referral', this)" class="flex flex-col items-center gap-1 opacity-50">
            <span class="text-xl">üë•</span><span class="text-[10px]">Friends</span>
        </button>
        <button onclick="switchTab('withdraw', this)" class="flex flex-col items-center gap-1 opacity-50">
            <span class="text-xl">üí∞</span><span class="text-[10px]">Wallet</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCF6T9Rz0k3YMLVPbkq08Ph1jztg4TC8hM",
            authDomain: "toooon-68863.firebaseapp.com",
            projectId: "toooon-68863",
            storageBucket: "toooon-68863.firebasestorage.app",
            messagingSenderId: "782681606396",
            appId: "1:782681606396:web:03c6d943b76977a7f52f79"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id.toString() : "dev_user";
        const userName = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.first_name : "User";

        window.state = {
            balance: 0.0,
            miningTime: 60,
            miningProfit: 0.0001,
            minWithdraw: 0.1,
            refProfit: 0.0001,
            isMining: false,
            referrals: [],
            history: [],
            adminClicks: 0
        };

        const tasks = [
            { id: 1, title: "Watch Monetag Ad", reward: 0.0001 },
            { id: 2, title: "Join Telegram Channel", reward: 0.0005 }
        ];

        async function initApp() {
            const userRef = doc(db, "users", userId);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
                window.state = { ...window.state, ...userSnap.data() };
            } else {
                const newUser = {
                    balance: 0,
                    miningTime: 60,
                    miningProfit: 0.0001,
                    minWithdraw: 0.1,
                    refProfit: 0.0001,
                    referrals: [],
                    history: []
                };
                await setDoc(userRef, newUser);
                window.state = { ...window.state, ...newUser };
                
                const startParam = tg.initDataUnsafe.start_param;
                if (startParam && startParam !== userId) {
                    const refRef = doc(db, "users", startParam);
                    await updateDoc(refRef, {
                        balance: increment(0.0001),
                        referrals: arrayUnion({ name: userName, profit: 0.0001 })
                    });
                }
            }
            renderUI();
        }

        window.renderUI = () => {
            document.getElementById('balance').innerText = window.state.balance.toFixed(4);
            document.getElementById('sessionTimeText').innerText = window.state.miningTime;
            document.getElementById('hourlyProfitText').innerText = window.state.miningProfit;
            document.getElementById('refBonusText').innerText = window.state.refProfit;
            document.getElementById('minWithdrawText').innerText = window.state.minWithdraw;
            document.getElementById('refCount').innerText = window.state.referrals.length;
            document.getElementById('refLink').value = `https://t.me/BNBFaucet20_bot?start=${userId}`;

            const taskBox = document.getElementById('tasksContainer');
            taskBox.innerHTML = tasks.map(t => `
                <div class="glass p-4 flex justify-between items-center">
                    <div><p class="font-bold text-sm">${t.title}</p><p class="text-blue-400 text-[10px]">+ ${t.reward} TON</p></div>
                    <button onclick="completeTask(${t.reward})" class="bg-white/10 px-4 py-2 rounded-xl text-xs font-bold">VIEW</button>
                </div>
            `).join('');

            const refBox = document.getElementById('refList');
            refBox.innerHTML = window.state.referrals.length > 0 ? window.state.referrals.map(r => `
                <div class="flex justify-between border-b border-white/5 pb-2">
                    <span class="text-xs">üë§ ${r.name}</span><span class="text-xs text-orange-400 font-bold">+${r.profit}</span>
                </div>
            `).join('') : '<p class="text-xs opacity-40 text-center py-4">No friends yet</p>';
            
            const histBox = document.getElementById('withdrawHistory');
            histBox.innerHTML = window.state.history.map(h => `
                <div class="glass p-3 flex justify-between items-center">
                    <span class="text-[10px] opacity-50">${h.addr.substring(0,8)}...</span>
                    <span class="font-bold text-xs">${h.amount} TON</span>
                    <span class="text-yellow-400 text-[10px] font-bold uppercase">${h.text}</span>
                </div>
            `).join('');
        };

        window.startMiningProcess = () => {
            if(window.state.isMining) return;
            window.state.isMining = true;
            document.getElementById('miningBox').classList.add('active-mining');
            document.getElementById('startBtn').disabled = true;
            
            let timeLeft = window.state.miningTime * 60;
            const timer = setInterval(async () => {
                let m = Math.floor(timeLeft / 60);
                let s = timeLeft % 60;
                document.getElementById('timerText').innerText = `${m}:${s < 10 ? '0'+s : s}`;
                document.getElementById('liveCounter').innerText = (parseFloat(document.getElementById('liveCounter').innerText) + (window.state.miningProfit / (window.state.miningTime * 60))).toFixed(6);

                if(timeLeft <= 0) {
                    clearInterval(timer);
                    window.state.isMining = false;
                    window.state.balance += window.state.miningProfit;
                    await updateDoc(doc(db, "users", userId), { balance: window.state.balance });
                    document.getElementById('miningBox').classList.remove('active-mining');
                    document.getElementById('startBtn').disabled = false;
                    renderUI();
                    alert("Mining finished and saved!");
                }
                timeLeft--;
            }, 1000);
        };

        window.completeTask = async (reward) => {
            alert("Redirecting to task...");
            setTimeout(async () => {
                window.state.balance += reward;
                await updateDoc(doc(db, "users", userId), { balance: window.state.balance });
                renderUI();
                alert("Task reward added!");
            }, 3000);
        };

        window.requestWithdraw = async () => {
            const amt = parseFloat(document.getElementById('withdrawAmount').value);
            const addr = document.getElementById('walletAddr').value;
            if(amt < window.state.minWithdraw || amt > window.state.balance) return alert("Invalid amount");
            
            window.state.balance -= amt;
            const newHistory = { id: Date.now(), addr: addr, amount: amt, text: "Under Review" };
            window.state.history.unshift(newHistory);
            await updateDoc(doc(db, "users", userId), { balance: window.state.balance, history: window.state.history });
            renderUI();
            alert("Withdrawal requested!");
        };

        window.switchTab = (page, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => b.classList.add('opacity-50'));
            el.classList.remove('opacity-50');
            el.classList.add('tab-active');
        };

        window.checkAdminTrigger = () => {
            window.state.adminClicks++;
            if(window.state.adminClicks >= 8) {
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('adm_miningTime').value = window.state.miningTime;
                document.getElementById('adm_miningProfit').value = window.state.miningProfit;
                window.state.adminClicks = 0;
            }
        };

        window.saveAdminChanges = async () => {
            window.state.miningTime = parseInt(document.getElementById('adm_miningTime').value);
            window.state.miningProfit = parseFloat(document.getElementById('adm_miningProfit').value);
            await updateDoc(doc(db, "users", userId), { miningTime: window.state.miningTime, miningProfit: window.state.miningProfit });
            alert("Settings Saved!");
            closeAdmin();
            renderUI();
        };

        window.closeAdmin = () => document.getElementById('adminPanel').classList.add('hidden');
        window.copyRef = () => {
            navigator.clipboard.writeText(document.getElementById('refLink').value);
            alert("Copied!");
        };

        initApp();
    </script>
</body>
</html>
